<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Урок 1. Введение, простой echo-бот
| Пишем ботов для Telegram на языке Python</title><link rel=stylesheet href=/test-web/css/override.css><link rel=stylesheet href=/telegram-tutorial/book.min.b7c4a27ae7333f2fd90f74328a06079ce9a887b15763d645a1ce5ad459fe9881.css><meta property="og:title" content="Пишем ботов для Telegram на языке Python"><meta property="og:image" content="https://telegram.org/file/811140058/2/7GzMJk4Ij54/a1649c56fa9f805828"><meta property="og:description" content="Учебник для ботописателей"><link rel=icon href=/telegram-tutorial/favicon.png type=image/x-icon></head><body><input type=checkbox style=display:none id=menu-control><main class="flex container"><aside class="book-menu fixed"><nav><h2 class=book-brand><a href=https://mastergroosha.github.io/telegram-tutorial/>Пишем ботов для Telegram на языке Python</a></h2><style>nav ul a[href$=\2ftelegram-tutorial\2f docs\2flesson_01\2f ]{color:#004ed0}</style><ul><li><a href=/telegram-tutorial/docs/lesson_00/>Урок 0. Подготовка рабочего места в Windows и Linux. Virtual Environment (venv). Ответы на вопросы</a></li><li><a href=/telegram-tutorial/docs/lesson_01/>Урок 1. Введение, простой echo-бот</a></li><li><a href=/telegram-tutorial/docs/lesson_02/>Урок 2. “Угадай мелодию”. Подготовка</a></li><li><a href=/telegram-tutorial/docs/lesson_03/>Урок 3. “Угадай мелодию”. Завершаем бота</a></li><li><a href=/telegram-tutorial/docs/lesson_04/>Урок 4. Вебхуки</a></li><li><a href=/telegram-tutorial/docs/lesson_05/>Урок 5. Автопостинг в каналы</a></li><li><a href=/telegram-tutorial/docs/lesson_06/>Урок 6. Собираем аналитику при помощи Botan</a></li><li><a href=/telegram-tutorial/docs/lesson_07/>Урок 7. Встраиваемые боты (Inline)</a></li><li><a href=/telegram-tutorial/docs/lesson_08/>Урок 8. Bot API v2: Кнопки и редактирование сообщений</a></li><li><a href=/telegram-tutorial/docs/lesson_09/>Урок 9. Bot API v2: Специальные кнопки, опять редактирование сообщений, кэшированный инлайн</a></li><li><a href=/telegram-tutorial/docs/lesson_10/>Урок 10. Bot API v3. Автоматизируем работу в группах</a></li><li><a href=/telegram-tutorial/docs/lesson_11/>Урок 11. Ведём (более-менее) осмысленные диалоги. Конечные автоматы</a></li><li><a href=/telegram-tutorial/docs/lesson_12/>Урок 12. Запускаем несколько ботов на одном сервере</a></li></ul></nav></aside><div class=book-page><header class="align-center justify-between book-header"><label for=menu-control><img src=/telegram-tutorial/svg/menu.svg alt=Menu></label></header><header class=markdown><h1>Урок 1. Введение, простой echo-бот</h1></header><article class=markdown><h2 id=heading>Введение</h2><p>Приветствую тебя, читатель! Telegram Bot API – это мощный инструмент для вообще чего угодно. Автоматизация действий, работа с пользователями, онлайн-магазины, игры и много чего ещё. В этом учебнике мы научимся писать ботов для Telegram на языке Python.</p><p>Сразу оговорюсь: тот бот, который получится в итоге - это лишь прототип, цель всех этих постов - рассказать об основах ботостроения, показать, как можно за короткое время написать простого бота для своих нужд.</p><p>Язык программирования будет Python 3, но это не означает, что любители PHP, Ruby и т.д. в пролёте; все основные принципы совпадают. Я не буду особо останавливаться на описании самого языка, желающие могут ознакомиться с документацией по Python <a href=https://www.python.org/doc/versions/>здесь</a>.</p><h2 id=-->Подготовка к запуску</h2><p>Взаимодействие ботов с людьми основано на HTTP-запросах. С первых дней появления API ботов, я использую библиотеку <a href=https://github.com/eternnoir/pyTelegramBotAPI>pyTelegramBotAPI</a>, которая берет на себя все нюансы отправки и получения запросов, позволяя сконцентрироваться непосредственно на логике. Установка библиотеки предельно простая:</p><pre><code class=language-none data-lang=none>pip install pytelegrambotapi
python3</code></pre><center><figure style="padding:.25rem;margin:1rem 0"><img style=max-width:100%;height:auto src=/telegram-tutorial/images/l1_1.jpg alt="Скриншот из терминала с запущенным интерпретатором Python"><figcaption><h4><i>Скриншот из терминала с запущенным интерпретатором Python</i></h4></figcaption></figure></center><p>Теперь можно выйти из режима Python-консоли (Ctrl+Z или Ctrl+D, или <code>exit()</code>)</p><h2 id=--echo->Пишем простого echo-бота</h2><p>Ну, довольно слов, перейдем к делу. В качестве практики к первому уроку, напишем бота, повторяющему присланное текстовое сообщение. Создадим каталог, а внутри него создадим 2 файла: <code>bot.py</code> и <code>config.py</code>. Я рекомендую выносить различные константы и настройки в файл <code>config.py</code>, дабы не загромождать другие. В файл <code>config.py</code> впишем:</p><pre><code class=language-none data-lang=none># -*- coding: utf-8 -*-
# Токен ненастоящий :) Подставьте свой
token = '1234567890:AAE_abCDEFghijKLmNOpqRsTuVWxyz'</code></pre><p>Теперь надо научить бота реагировать на сообщения. Напишем обработчик, который будет реагировать на все текстовые сообщения.</p><pre><code class=language-none data-lang=none>@bot.message_handler(content_types=["text"])
def repeat_all_messages(message): # Название функции не играет никакой роли, в принципе
    bot.send_message(message.chat.id, message.text)</code></pre><p>У читателя возникнет вопрос: зачем там символ &ldquo;@"? Что это вообще за <code>message_handler</code>? Дело в том, что после приёма сообщения от Telegram его надо обработать по-разному в зависимости от того, что это за сообщение: текст &ldquo;привет&rdquo; или текст &ldquo;пока&rdquo;, может быть, вообще стикер или музыка. Первое, что придёт в голову – написать множество конструкций <code>if-then-else</code>, но такой подход некрасивый и позволяет быстро запутаться.<br>Для решения этой проблемы автор библиотеки pyTelegramBotAPI реализовал механизм хэндлеров, которые используют питоновские <a href=https://devpractice.ru/python-lesson-19-decorators>декораторы</a> (пока просто запомним это слово). В хэндлере описывается, в каком случае необходимо выполнять ту или иную функцию. Например, хэндлер <code>@bot.message_handler(content_types=["text"])</code> выполнит нижестоящую функцию, если от Telegram придёт текстовое сообщение, а хэндлер <code>@bot.message_handler(commands=["start"])</code> сработает при получении команды <strong>/start</strong>.</p><p>Теперь запустим бесконечный цикл получения новых записей со стороны Telegram:</p><pre><code class=language-none data-lang=none>if __name__ == '__main__':
    bot.infinity_polling()</code></pre><p>Функция infinity_polling запускает т.н. <a href=http://www.pubnub.com/blog/http-long-polling/>Long Polling</a>, бот должен стараться не прекращать работу при возникновении каких-либо ошибок. При этом, само собой, за ботом нужно следить, ибо сервера Telegram периодически перестают отвечать на запросы или делают это с большой задержкой приводя к <a href=https://ru.wikipedia.org/wiki/%D0%A1%D0%BF%D0%B8%D1%81%D0%BE%D0%BA_%D0%BA%D0%BE%D0%B4%D0%BE%D0%B2_%D1%81%D0%BE%D1%81%D1%82%D0%BE%D1%8F%D0%BD%D0%B8%D1%8F_HTTP#5xx>ошибкам 5xx</a>)</p><p>Итак, полный код файла <code>bot.py</code> выглядит следующим образом:</p><pre><code class=language-none data-lang=none># -*- coding: utf-8 -*-
import config
import telebot

bot = telebot.TeleBot(config.token)

@bot.message_handler(content_types=["text"])
def repeat_all_messages(message): # Название функции не играет никакой роли, в принципе
    bot.send_message(message.chat.id, message.text)

if __name__ == '__main__':
     bot.infinity_polling()</code></pre><p>Готово! Осталось запустить бота: <code>python3 bot.py</code></p><center><figure style="padding:.25rem;margin:1rem 0"><img style=max-width:100%;height:auto src=/telegram-tutorial/images/l1_2.jpg alt="Бот работает"><figcaption><h4><i>Бот работает</i></h4></figcaption></figure></center><p>На этом первый урок окончен.</p><a href=/telegram-tutorial/docs/lesson_02/ class=book-btn style=float:right>Урок №2 →</a></article></div><aside class="book-toc level-3 fixed"><nav id=TableOfContents><ul><li><a href=#heading>Введение</a></li><li><a href=#-->Подготовка к запуску</a></li><li><a href=#--echo->Пишем простого echo-бота</a></li></ul></nav></aside></main></body></html>